#!/bin/bash

# Apply the updated deployment
kubectl apply -f blue_deployment.yaml

# Trigger the rolling update (Kubernetes automatically handles it)
echo "Monitoring rollout..."
kubectl rollout status deployment/messaging-app-blue

# Test the app for downtime by sending requests continuously
BLUE_POD=$(kubectl get pods -l app=messaging-app-blue -o jsonpath="{.items[0].metadata.name}")

echo "Testing if the app is responding during rollout..."
for i in {1..10}; do
    RESPONSE=$(kubectl exec $BLUE_POD -- curl -s -o /dev/null -w "%{http_code}" http://localhost:8000)
    echo "Request $i: HTTP status $RESPONSE"
    sleep 2
done

echo "Current pods:"
kubectl get pods -l app=messaging-app-blue
